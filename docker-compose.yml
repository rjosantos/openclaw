services:
  ts-openclaw:
    image: tailscale/tailscale:latest
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_AUTHKEY
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - tailscale_state_openclaw:/var/lib/tailscale
    healthcheck:
      test: ["CMD-SHELL", "tailscale status --json >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    command: >
      sh -c "
      tailscaled --state=/var/lib/tailscale/tailscaled.state &
      sleep 2 &&
      tailscale up --authkey=${TS_AUTHKEY} --hostname=nodered --advertise-tags=tag:funnel &&
      tailscale funnel --bg --https=443 --set-path=/ --yes http://127.0.0.1:1880 &&
      tail -f /dev/null
      "

  openclaw-gateway:
    build:
      context: .
    image: openclaw:local
    container_name: openclaw-gateway
    network_mode: "service:ts-openclaw"
    depends_on:
      ts-openclaw:
        condition: service_healthy
    environment:
      - HOME=/home/node
      - TERM=xterm-256color
      - OPENCLAW_GATEWAY_TOKEN
      - CLAUDE_AI_SESSION_KEY=${CLAUDE_AI_SESSION_KEY}
      - CLAUDE_WEB_SESSION_KEY=${CLAUDE_WEB_SESSION_KEY}
      - CLAUDE_WEB_COOKIE=${CLAUDE_WEB_COOKIE}
    volumes:
      - /root/.openclaw:/home/node/.openclaw
      - /root/.openclaw/workspace:/home/node/.openclaw/workspace
    init: true
    restart: unless-stopped
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "lan",
        "--port",
        "18789"
      ]

  openclaw-cli:
    image: openclaw:local
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
    volumes:
      - /root/.openclaw:/home/node/.openclaw
      - /root/.openclaw/workspace:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    user: "0:0"
    restart: unless-stopped
    entrypoint: ["bash","-lc"]
    command: ["sleep infinity"]

volumes:
  tailscale_state_openclaw:
